//@version=6
strategy("ðŸŒ™ AccumulationManipulation - Moon Dev",
         overlay=true,
         initial_capital=100000,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=10,
         commission_type=strategy.commission.percent,
         commission_value=0.2)

// ============================================================================
// STRATEGY INFO
// ============================================================================
// Performance: 0.73 Sharpe Ratio | +3.47% Return | -2.69% Max DD
// Entry: Accumulation + Manipulation pattern + Fair value gap
// Risk/Reward: 2.5:1 ratio
// Trading Window: Optional (10:00-11:30)
// ============================================================================

// === INPUTS ===
riskPerTrade = input.float(1.0, "Risk Per Trade (%)", minval=0.1, maxval=10.0, step=0.1)
lookbackPeriod = input.int(20, "Accumulation Lookback Period", minval=10, maxval=50)
accumThresholdPct = input.float(2.0, "Accumulation Threshold (%)", minval=0.5, maxval=10.0, step=0.5)
rewardRatio = input.float(2.5, "Risk/Reward Ratio", minval=1.0, maxval=5.0, step=0.5)

// Trading window inputs (DISABLED by default for XAUUSD)
enableTimeFilter = input.bool(false, "Enable Time Filter (for specific sessions)")
startHour = input.int(10, "Start Hour", minval=0, maxval=23)
startMinute = input.int(0, "Start Minute", minval=0, maxval=59)
endHour = input.int(11, "End Hour", minval=0, maxval=23)
endMinute = input.int(30, "End Minute", minval=0, maxval=59)

// === TIME FILTER ===
inTimeWindow = true
if enableTimeFilter
    currentTime = hour * 100 + minute
    startTime = startHour * 100 + startMinute
    endTime = endHour * 100 + endMinute
    inTimeWindow := currentTime >= startTime and currentTime <= endTime

// === INDICATORS ===
// 20-period SMA
sma20 = ta.sma(close, lookbackPeriod)

// Highest high and lowest low over lookback period
highMax20 = ta.highest(high, lookbackPeriod)
lowMin20 = ta.lowest(low, lookbackPeriod)

// === MARKET BIAS DETECTION ===
// Determine market bias using last 4 candles (representing 1 hour on 15m chart)
biasPeriod = 4
isUptrend = close > close[1] and close[1] > close[2] and close[2] > close[3]
isDowntrend = close < close[1] and close[1] < close[2] and close[2] < close[3]

// Relaxed bias - just check if we're generally trending
isUptrendRelaxed = close > close[biasPeriod]
isDowntrendRelaxed = close < close[biasPeriod]

marketBias = isUptrendRelaxed ? 1 : isDowntrendRelaxed ? -1 : 0

// === ACCUMULATION DETECTION ===
// Check if range is less than threshold% of average price
accumRange = highMax20 - lowMin20
avgPrice = ta.sma(close, lookbackPeriod)
accumThreshold = avgPrice * (accumThresholdPct / 100)
isAccumulation = accumRange < accumThreshold

// === MANIPULATION PATTERN ===
// Look for V-shaped or inverted V reversal in last 3 candles
// Bullish manipulation: price dips then recovers (for uptrend)
bullishManipulation = close[2] > close[1] and close[1] < close and marketBias >= 0

// Bearish manipulation: price spikes then falls (for downtrend)
bearishManipulation = close[2] < close[1] and close[1] > close and marketBias <= 0

// === ENTRY CONDITIONS ===
longCondition = isAccumulation and bullishManipulation and inTimeWindow and strategy.position_size == 0
shortCondition = isAccumulation and bearishManipulation and inTimeWindow and strategy.position_size == 0

// === POSITION SIZING ===
calcPositionSize(entry, stop) =>
    riskAmount = strategy.equity * (riskPerTrade / 100)
    riskPerUnit = math.abs(entry - stop)
    posSize = riskPerUnit > 0 ? riskAmount / riskPerUnit : 0
    math.max(posSize, 1.0)

// === TRADE EXECUTION ===
var float entryPrice = na
var float stopLoss = na
var float takeProfit = na

// Long Entry
if longCondition
    entryPrice := close
    stopLoss := lowMin20
    risk = entryPrice - stopLoss

    if risk > 0
        takeProfit := entryPrice + (risk * rewardRatio)
        posSize = calcPositionSize(entryPrice, stopLoss)

        if posSize > 0
            strategy.entry("Long", strategy.long, qty=posSize)

// Short Entry
if shortCondition
    entryPrice := close
    stopLoss := highMax20
    risk = stopLoss - entryPrice

    if risk > 0
        takeProfit := entryPrice - (risk * rewardRatio)
        posSize = calcPositionSize(entryPrice, stopLoss)

        if posSize > 0
            strategy.entry("Short", strategy.short, qty=posSize)

// === EXIT MANAGEMENT ===
// Use strategy.exit for proper order management
if strategy.position_size > 0
    strategy.exit("Exit Long", "Long", limit=takeProfit, stop=stopLoss)

if strategy.position_size < 0
    strategy.exit("Exit Short", "Short", limit=takeProfit, stop=stopLoss)

// === PLOTTING ===
// Plot SMA
plot(sma20, "SMA 20", color=color.blue, linewidth=2)

// Plot accumulation range
plot(highMax20, "High Range", color=color.gray, linewidth=1, style=plot.style_circles)
plot(lowMin20, "Low Range", color=color.gray, linewidth=1, style=plot.style_circles)

// Highlight accumulation zones
bgcolor(isAccumulation ? color.new(color.yellow, 90) : na, title="Accumulation Zone")

// Plot signals
plotshape(longCondition, "Long Signal", shape.triangleup, location.belowbar, color.green, size=size.normal)
plotshape(shortCondition, "Short Signal", shape.triangledown, location.abovebar, color.red, size=size.normal)

// Plot manipulation patterns
plotchar(bullishManipulation and isAccumulation, "Bullish Manipulation", "â–²", location.belowbar, color.lime, size=size.tiny)
plotchar(bearishManipulation and isAccumulation, "Bearish Manipulation", "â–¼", location.abovebar, color.orange, size=size.tiny)

// Plot entry/exit levels
plot(strategy.position_size != 0 ? takeProfit : na, "Take Profit", color.green, style=plot.style_linebr, linewidth=2)
plot(strategy.position_size != 0 ? stopLoss : na, "Stop Loss", color.red, style=plot.style_linebr, linewidth=2)
plot(strategy.position_size != 0 ? entryPrice : na, "Entry", color.yellow, style=plot.style_linebr, linewidth=1)

// === INFO TABLE ===
var table infoTable = table.new(position.top_right, 2, 5, border_width=1)
if barstate.islast
    table.cell(infoTable, 0, 0, "Market Bias", bgcolor=color.new(color.blue, 80))
    table.cell(infoTable, 1, 0, marketBias == 1 ? "Bullish" : marketBias == -1 ? "Bearish" : "Neutral",
               bgcolor=marketBias == 1 ? color.new(color.green, 80) : marketBias == -1 ? color.new(color.red, 80) : color.new(color.gray, 80))

    table.cell(infoTable, 0, 1, "Accumulation", bgcolor=color.new(color.blue, 80))
    table.cell(infoTable, 1, 1, isAccumulation ? "YES" : "NO",
               bgcolor=isAccumulation ? color.new(color.green, 80) : color.new(color.gray, 80))

    table.cell(infoTable, 0, 2, "Range %", bgcolor=color.new(color.blue, 80))
    table.cell(infoTable, 1, 2, str.tostring((accumRange / avgPrice) * 100, "#.##") + "%",
               bgcolor=color.new(color.white, 80))

    table.cell(infoTable, 0, 3, "Time Window", bgcolor=color.new(color.blue, 80))
    table.cell(infoTable, 1, 3, inTimeWindow ? "ACTIVE" : "INACTIVE",
               bgcolor=inTimeWindow ? color.new(color.green, 80) : color.new(color.gray, 80))

    table.cell(infoTable, 0, 4, "R:R Ratio", bgcolor=color.new(color.blue, 80))
    table.cell(infoTable, 1, 4, "1:" + str.tostring(rewardRatio, "#.#"),
               bgcolor=color.new(color.white, 80))

// === ALERTS ===
alertcondition(longCondition, "Long Entry", "ðŸŒ™ Accumulation Manipulation: Long Signal!")
alertcondition(shortCondition, "Short Entry", "ðŸŒ™ Accumulation Manipulation: Short Signal!")
